<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Session Replay</title>
    <script>const LANG = '{{ lang }}';</script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1e1e1e;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            margin-bottom: 30px;
            color: #4a9eff;
            font-size: 28px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .main-grid.editor-mode {
            grid-template-columns: 1fr;
        }

        .main-grid.editor-mode .left-panel,
        .main-grid.editor-mode .right-panel {
            display: none;
        }

        .panel {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
        }

        .panel h2 {
            font-size: 16px;
            color: #4a9eff;
            margin-bottom: 15px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 13px;
            color: #aaa;
            margin-bottom: 8px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 16px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #333;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        button:hover {
            background: #444;
            border-color: #666;
        }

        button.active {
            background: #4a9eff;
            border-color: #4a9eff;
            color: white;
            font-weight: bold;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: monospace;
            font-size: 12px;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #4a9eff;
            background: #222;
        }

        .sessions-list {
            list-style: none;
            max-height: 500px;
            overflow-y: auto;
        }

        .sessions-list li {
            padding: 10px;
            margin-bottom: 8px;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }

        .sessions-list li:hover {
            background: #3a3a3a;
            border-color: #555;
        }

        .sessions-list li.selected {
            background: #4a9eff;
            border-color: #4a9eff;
            color: white;
        }

        .session-date {
            display: block;
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }

        .preview {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 800px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .editor-container {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
        }

        .editor-message {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .editor-message.deleted {
            opacity: 0.5;
            background: #3a2a2a;
            border-color: #664444;
        }

        .editor-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            color: #4a9eff;
            font-weight: bold;
            font-family: monospace;
            font-size: 12px;
        }

        .editor-message-header .label {
            flex: 1;
        }

        .editor-message-header .delete-btn {
            padding: 4px 8px;
            font-size: 12px;
            background: #8f4a4a;
            border-color: #8f4a4a;
            color: #ff6a6a;
            cursor: pointer;
        }

        .editor-message-header .delete-btn:hover {
            background: #a05a5a;
            border-color: #a05a5a;
        }

        .editor-message.deleted .delete-btn {
            background: #4a8f4a;
            border-color: #4a8f4a;
            color: #6aff6a;
        }

        .editor-message.deleted .delete-btn:hover {
            background: #5a9f5a;
            border-color: #5a9f5a;
        }

        .editor-textarea {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
            margin-bottom: 8px;
        }

        .editor-textarea:focus {
            outline: none;
            border-color: #4a9eff;
            background: #222;
        }

        .editor-message.deleted .editor-textarea {
            color: #888;
            background: #2a2a2a;
            border-color: #555;
        }

        .editor-tools-badge {
            display: inline-block;
            padding: 3px 8px;
            background: #444;
            border-radius: 3px;
            font-size: 11px;
            color: #999;
            margin-top: 6px;
        }

        .editor-message[data-block="user"] {
            border-left: 3px solid #4aff4a;
        }

        .editor-message[data-block="assistant"] {
            border-left: 3px solid #4a9eff;
        }

        .editor-message[data-block="tool"] {
            border-left: 3px solid #ff9f4a;
        }

        .editor-message[data-block="progress"] {
            border-left: 3px solid #888;
            opacity: 0.7;
        }

        .editor-message[data-block="file-history"] {
            border-left: 3px solid #888;
            opacity: 0.7;
        }

        .thinking-block {
            background: rgba(232, 192, 122, 0.1);
            border: 1px solid rgba(232, 192, 122, 0.3);
            border-radius: 4px;
            padding: 8px;
            margin: 8px 0;
            font-size: 12px;
        }

        .thinking-block-title {
            color: #e8c07a;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .thinking-block-content {
            background: #1a1a1a;
            border-radius: 3px;
            padding: 6px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            font-size: 11px;
            color: #ccc;
            max-height: 200px;
            overflow-y: auto;
        }

        .readonly-info {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px;
            margin: 8px 0;
            font-size: 12px;
            color: #aaa;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .output-area {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .output-markdown {
            font-size: 13px;
            line-height: 1.6;
        }

        .output-html {
            font-size: 13px;
        }

        .output-terminal {
            font-family: monospace;
            font-size: 12px;
        }

        .output-player {
            width: 100%;
            height: 600px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #4a9eff;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #444;
            border-top-color: #4a9eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .message {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .message.success {
            background: #1a3a1a;
            border: 1px solid #4a8f4a;
            color: #4aff4a;
        }

        .message.error {
            background: #3a1a1a;
            border: 1px solid #8f4a4a;
            color: #ff4a4a;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .controls button {
            flex: 1;
            padding: 12px;
            font-size: 14px;
            font-weight: bold;
        }

        .controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .download-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: #4a9eff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 13px;
        }

        .download-link:hover {
            background: #3a8eef;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 280px 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 data-i18n="title">üé¨ Claude Session Replay - Web UI</h1>

        <div class="main-grid">
            <!-- Left: Controls -->
            <div class="panel">
                <h2 data-i18n="settings">‚öôÔ∏è Settings</h2>

                <div class="form-group">
                    <label data-i18n="agent">Agent:</label>
                    <div class="button-group">
                        <button class="agent-btn active" data-agent="claude">Claude</button>
                        <button class="agent-btn" data-agent="codex">Codex</button>
                    </div>
                </div>

                <div class="form-group">
                    <label data-i18n="format">Format:</label>
                    <div class="button-group">
                        <button class="format-btn active" data-format="md">Markdown</button>
                        <button class="format-btn" data-format="html">HTML</button>
                        <button class="format-btn" data-format="player">üïê Player*</button>
                        <button class="format-btn" data-format="terminal">Terminal</button>
                    </div>
                    <small style="color: #666; margin-top: 8px; display: block;" data-i18n="player_note">* Player „Å´„ÅØ Alibai ModeÔºàÊôÇË®àË°®Á§∫„ÄÅÂÜçÁîü„É¢„Éº„ÉâÔºâ„ÅåÂê´„Åæ„Çå„Åæ„Åô</small>
                </div>

                <div class="form-group">
                    <label data-i18n="theme">Theme:</label>
                    <div class="button-group">
                        <button class="theme-btn active" data-theme="light">Light</button>
                        <button class="theme-btn" data-theme="console">Dark</button>
                    </div>
                </div>

                <div class="form-group">
                    <label data-i18n="range">Range (e.g., 1-50,53-):</label>
                    <input type="text" id="rangeInput" placeholder="Leave empty for all" data-i18n-ph="range_placeholder">
                </div>

                <div class="form-group">
                    <label data-i18n="alibai_label">üïê Alibai „Çπ„Çø„Éº„ÉàÊôÇÂàª (HH:MM):</label>
                    <input type="text" id="alibaiTimeInput" placeholder="e.g., 21:33 (Player „ÅÆ„Åø)" data-i18n-ph="alibai_placeholder">
                    <small style="color: #666; margin-top: 4px; display: block;" data-i18n="alibai_note">Player „Éï„Ç©„Éº„Éû„ÉÉ„Éà‰ΩøÁî®ÊôÇ„Å´ÊúâÂäπ</small>
                </div>

                <div class="form-group">
                    <label data-i18n="output_label">Output Path:</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="outputInput" placeholder="Leave empty for display only" data-i18n-ph="output_placeholder">
                        <button type="button" id="browseBtn" style="width: auto; padding: 8px 12px;" data-i18n="browse">üìÅ Browse</button>
                    </div>
                </div>
            </div>

            <!-- Center: Sessions & Preview/Editor -->
            <div class="panel">
                <h2 data-i18n="sessions">üìã Sessions</h2>
                <ul class="sessions-list" id="sessionsList"></ul>

                <!-- Preview section -->
                <div id="previewSection" style="display: none;">
                    <h2 style="margin-top: 20px;" data-i18n="preview_heading">üëÅÔ∏è Preview</h2>
                    <div class="preview" id="preview" style="display: block;">Select a session...</div>
                    <button id="editBtn" style="width: 100%; margin-top: 15px; padding: 10px; background: #4a9eff; border-color: #4a9eff; font-weight: bold;">‚úèÔ∏è Edit</button>
                </div>

                <!-- Editor section -->
                <div id="editorSection" style="display: none; display: flex; flex-direction: column; height: 100%;">
                    <div style="flex-shrink: 0;">
                        <h2 style="margin-top: 20px;" data-i18n="editor_heading">‚úèÔ∏è Editor</h2>
                        <div id="editorButtons" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                            <button id="previewBtn" style="flex: 1; min-width: 120px; padding: 10px; background: #4a9eff; border-color: #4a9eff; font-weight: bold;">üëÅÔ∏è Preview</button>
                            <button id="applyToOutputBtn" style="flex: 1; min-width: 180px; padding: 10px; background: #4a9eff; border-color: #4a9eff; font-weight: bold;" data-i18n="apply_to_output">üíæ Apply to Output</button>
                            <button id="applyToSessionBtn" style="flex: 1; min-width: 180px; padding: 10px; background: #8a4aff; border-color: #8a4aff; font-weight: bold;" data-i18n="apply_to_session_log">üíæ Apply to Session Log</button>
                        </div>
                    </div>
                    <div class="editor-container" id="editorContainer" style="max-height: calc(100vh - 250px); overflow-y: auto; flex: 1;">
                        <div id="editorMessages"></div>
                    </div>
                </div>

                <!-- Placeholder -->
                <div id="placeholderSection">
                    <h2 style="margin-top: 20px;" data-i18n="preview_heading">üëÅÔ∏è Preview</h2>
                    <div class="preview">Select a session to preview...</div>
                </div>
            </div>

            <!-- Right: Status -->
            <div class="panel">
                <h2 data-i18n="info">‚ÑπÔ∏è Info</h2>
                <p id="sessionInfo" style="font-size: 13px; line-height: 1.6; color: #aaa;" data-i18n="info_placeholder">
                    Select a session to view details...
                </p>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button id="runBtn" style="background: #4a9eff; border-color: #4a9eff; font-weight: bold;" data-i18n="run">‚ñ∂Ô∏è Run Conversion</button>
            <button id="resetBtn" data-i18n="reset">üîÑ Reset</button>
        </div>

        <!-- Messages -->
        <div id="messageContainer"></div>

        <!-- Output -->
        <div class="panel" id="outputPanel" style="display: none;">
            <h2 data-i18n="output_heading">üì§ Output</h2>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p data-i18n="processing">Processing...</p>
            </div>
            <div id="outputButtons" style="display: flex; gap: 10px;">
                <button id="viewBtn" style="flex: 1; padding: 12px; background: #4a9eff; border-color: #4a9eff; font-weight: bold;" data-i18n="view_btn">üîç Êñ∞„Çø„Éñ„ÅßË°®Á§∫</button>
                <button id="downloadBtn" style="flex: 1; padding: 12px; background: #4a9eff; border-color: #4a9eff; font-weight: bold;" data-i18n="download_btn">üíæ „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
            </div>
            <div class="output-area" id="outputArea" style="display: none;"></div>
        </div>
    </div>

    <script>
        let selectedAgent = 'claude';
        let selectedFormat = 'md';
        let selectedTheme = 'light';
        let selectedSession = null;
        let editorMessages = [];  // [{idx, lineIdx, role, text, hasTools, deleted, editedText}]

        // Agent selection
        document.querySelectorAll('.agent-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.agent-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedAgent = this.dataset.agent;
                loadSessions();
            });
        });

        // Format selection
        document.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedFormat = this.dataset.format;
            });
        });

        // Theme selection
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedTheme = this.dataset.theme;
            });
        });

        // Browse output button
        document.getElementById('browseBtn').addEventListener('click', async () => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.setAttribute('nwsaveas', 'output.html');
            fileInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    document.getElementById('outputInput').value = e.target.files[0].name;
                }
            });
            // For web, we'll just set a default filename suggestion
            const suggest = `output_${new Date().toISOString().slice(0,10)}.html`;
            document.getElementById('outputInput').value = suggest;
        });

        // Load sessions on startup
        function loadSessions() {
            fetch(`/api/sessions/${selectedAgent}`)
                .then(r => r.json())
                .then(data => {
                    const list = document.getElementById('sessionsList');
                    list.innerHTML = '';
                    data.sessions.forEach(session => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${session.project || 'Unknown'}</strong>
                            ${session.first_message ? `<div style="font-size: 12px; color: #999; margin-top: 4px;">"${session.first_message}${session.first_message.length >= 80 ? '...' : ''}"</div>` : ''}
                            <span class="session-date">${session.date_str} | ${session.size_str}</span>`;
                        li.addEventListener('click', () => selectSession(session, li));
                        list.appendChild(li);
                    });
                    selectedSession = null;
                    const dict = I18N[LANG] || I18N.en;
                    document.getElementById('preview').textContent = dict.preview_placeholder;
                })
                .catch(err => showMessage(`${MSG[LANG].load_error}${err}`, 'error'));
        }

        function renderEditor() {
            const container = document.getElementById('editorMessages');
            container.innerHTML = '';

            editorMessages.forEach(msg => {
                const card = document.createElement('div');
                card.className = `editor-message ${msg.deleted ? 'deleted' : ''}`;
                card.dataset.lineIdx = msg.lineIdx;
                card.dataset.block = msg.blockType || 'unknown';

                // Block type label
                const blockTypeLabel = msg.blockType ? msg.blockType.toUpperCase() : 'UNKNOWN';
                const deleteBtn = msg.deleted ? 'Restore' : '‚úï Delete';
                const headerLabel = `#${msg.idx} [${blockTypeLabel}]`;

                // Build header
                const headerDiv = document.createElement('div');
                headerDiv.className = 'editor-message-header';

                const labelDiv = document.createElement('div');
                labelDiv.className = 'label';
                labelDiv.textContent = headerLabel;
                headerDiv.appendChild(labelDiv);

                const buttonDiv = document.createElement('div');
                buttonDiv.style.display = 'flex';
                buttonDiv.style.gap = '12px';
                buttonDiv.style.alignItems = 'center';

                // Edit/Apply/Cancel buttons (for editable messages)
                if (msg.blockType === 'user' || msg.blockType === 'assistant') {
                    const isEditing = msg.isInEditingMode;

                    if (!isEditing) {
                        // Show Edit button
                        const editBtn = document.createElement('button');
                        editBtn.type = 'button';
                        editBtn.className = 'delete-btn';
                        editBtn.style.background = '#4a8eff';
                        editBtn.style.borderColor = '#4a8eff';
                        editBtn.style.color = 'white';
                        editBtn.textContent = '‚úèÔ∏è Edit';
                        editBtn.dataset.lineIdx = msg.lineIdx;
                        editBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            editMessage(parseInt(this.dataset.lineIdx));
                        });
                        buttonDiv.appendChild(editBtn);

                        // Show Rollback button if content has been edited and applied
                        if (msg.editedText !== undefined && msg.editedText !== msg.text) {
                            const rollbackBtn = document.createElement('button');
                            rollbackBtn.type = 'button';
                            rollbackBtn.className = 'delete-btn';
                            rollbackBtn.style.background = '#ff9f4a';
                            rollbackBtn.style.borderColor = '#ff9f4a';
                            rollbackBtn.style.color = '#1e1e1e';
                            rollbackBtn.textContent = '‚Ü∂ Rollback';
                            rollbackBtn.dataset.lineIdx = msg.lineIdx;
                            rollbackBtn.addEventListener('click', function(e) {
                                e.preventDefault();
                                rollbackEdit(parseInt(this.dataset.lineIdx));
                            });
                            buttonDiv.appendChild(rollbackBtn);
                        }
                    } else {
                        // Show Apply and Cancel buttons
                        const applyBtn = document.createElement('button');
                        applyBtn.type = 'button';
                        applyBtn.className = 'delete-btn';
                        applyBtn.style.background = '#4aff4a';
                        applyBtn.style.borderColor = '#4aff4a';
                        applyBtn.style.color = '#1e1e1e';
                        applyBtn.textContent = '‚úÖ Apply';
                        applyBtn.dataset.lineIdx = msg.lineIdx;
                        applyBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            applyEdit(parseInt(this.dataset.lineIdx));
                        });
                        buttonDiv.appendChild(applyBtn);

                        const cancelBtn = document.createElement('button');
                        cancelBtn.type = 'button';
                        cancelBtn.className = 'delete-btn';
                        cancelBtn.style.background = '#ff6a6a';
                        cancelBtn.style.borderColor = '#ff6a6a';
                        cancelBtn.style.color = 'white';
                        cancelBtn.textContent = '‚úï Cancel';
                        cancelBtn.dataset.lineIdx = msg.lineIdx;
                        cancelBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            cancelEdit(parseInt(this.dataset.lineIdx));
                        });
                        buttonDiv.appendChild(cancelBtn);
                    }
                }

                // Delete checkbox
                const deleteCheckbox = document.createElement('input');
                deleteCheckbox.type = 'checkbox';
                deleteCheckbox.checked = msg.deleted;
                deleteCheckbox.title = msg.deleted ? 'Âæ©ÂÖÉ' : 'ÂâäÈô§‰∫àÂÆö';
                deleteCheckbox.style.cursor = 'pointer';
                deleteCheckbox.style.width = '18px';
                deleteCheckbox.style.height = '18px';
                deleteCheckbox.onchange = () => toggleMessageDelete(msg.lineIdx);

                const deleteLabel = document.createElement('label');
                deleteLabel.style.display = 'flex';
                deleteLabel.style.alignItems = 'center';
                deleteLabel.style.gap = '6px';
                deleteLabel.style.cursor = 'pointer';
                deleteLabel.style.fontSize = '12px';
                deleteLabel.style.color = msg.deleted ? '#ff6a6a' : '#aaa';
                deleteLabel.textContent = msg.deleted ? 'Âæ©ÂÖÉ' : 'ÂâäÈô§';
                deleteLabel.appendChild(deleteCheckbox);
                buttonDiv.appendChild(deleteLabel);

                headerDiv.appendChild(buttonDiv);
                card.appendChild(headerDiv);

                // Handle different block types
                if (msg.blockType === 'user' || msg.blockType === 'assistant') {
                    // Editable text for user and assistant messages
                    const currentText = msg.editedText !== undefined ? msg.editedText : msg.text;

                    // Show tool results if present (for user messages with tool results)
                    if (msg.tool_results && msg.tool_results.length > 0) {
                        msg.tool_results.forEach((result, idx) => {
                            const resultDiv = document.createElement('div');
                            resultDiv.className = 'readonly-info';
                            const resultContent = typeof result.content === 'string'
                                ? result.content.substring(0, 150)
                                : JSON.stringify(result.content).substring(0, 150);
                            resultDiv.textContent = `üìã Tool Result: ${resultContent}`;
                            card.appendChild(resultDiv);
                        });
                    }

                    // Show thinking blocks for assistant
                    if (msg.blockType === 'assistant' && msg.thinking && msg.thinking.length > 0) {
                        msg.thinking.forEach((thought, idx) => {
                            if (thought.trim()) {
                                const thinkingDiv = document.createElement('div');
                                thinkingDiv.className = 'thinking-block';
                                thinkingDiv.innerHTML = `
                                    <div class="thinking-block-title">üí≠ ÊÄùËÄÉ ${idx > 0 ? `#${idx + 1}` : ''}</div>
                                    <div class="thinking-block-content">${escapeHtml(thought.trim())}</div>
                                `;
                                card.appendChild(thinkingDiv);
                            }
                        });
                    }

                    // Add label if thinking is present
                    if (msg.blockType === 'assistant' && msg.thinking && msg.thinking.length > 0) {
                        const label = document.createElement('div');
                        label.style.fontSize = '12px';
                        label.style.color = '#aaa';
                        label.style.marginTop = '8px';
                        label.style.marginBottom = '4px';
                        label.textContent = 'üí¨ „Ç¢„Ç∑„Çπ„Çø„É≥„Éà„ÅÆÂøúÁ≠î:';
                        card.appendChild(label);
                    }

                    // Text textarea
                    const textarea = document.createElement('textarea');
                    textarea.className = 'editor-textarea';
                    textarea.dataset.lineIdx = msg.lineIdx;

                    // Check if currently in editing mode
                    const isInEditingMode = msg.isInEditingMode;

                    // Set placeholder based on whether there's thinking
                    if (msg.blockType === 'assistant' && msg.thinking && msg.thinking.length > 0) {
                        if (!currentText.trim()) {
                            textarea.placeholder = isInEditingMode ? 'ÊÄùËÄÉ„Å´ÂØæÂøú„Åô„ÇãÂøúÁ≠î„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ...' : '‚ö†Ô∏è „ÉÜ„Ç≠„Çπ„Éà„ÅåÁ©∫„Åß„Åô„ÄÇ„ÄåEdit„Äç„ÇíÊäº„Åó„Å¶Á∑®ÈõÜ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                            if (!isInEditingMode) {
                                textarea.style.borderColor = '#ff9f4a';
                            }
                        } else {
                            textarea.placeholder = isInEditingMode ? 'Edit message text...' : '„ÄåEdit„Äç„ÇíÊäº„Åó„Å¶Á∑®ÈõÜ„ÇíÈñãÂßã„Åó„Åæ„Åô';
                        }
                    } else {
                        textarea.placeholder = isInEditingMode ? 'Edit message text...' : '„ÄåEdit„Äç„ÇíÊäº„Åó„Å¶Á∑®ÈõÜ„ÇíÈñãÂßã„Åó„Åæ„Åô';
                    }

                    textarea.value = currentText;
                    textarea.disabled = msg.isReadOnly || !isInEditingMode;  // Disable unless Edit is clicked
                    card.appendChild(textarea);

                    // Add event listener for text changes (only works if enabled)
                    textarea.addEventListener('change', (e) => {
                        const msgIdx = editorMessages.findIndex(m => m.lineIdx === parseInt(e.target.dataset.lineIdx));
                        if (msgIdx >= 0) {
                            editorMessages[msgIdx].editedText = e.target.value;
                        }
                    });

                    textarea.addEventListener('input', (e) => {
                        const msgIdx = editorMessages.findIndex(m => m.lineIdx === parseInt(e.target.dataset.lineIdx));
                        if (msgIdx >= 0) {
                            editorMessages[msgIdx].editedText = e.target.value;
                        }
                    });

                    // Add tool uses if present
                    if (msg.tool_uses && msg.tool_uses.length > 0) {
                        msg.tool_uses.forEach((tool_use, idx) => {
                            const toolDiv = document.createElement('div');
                            toolDiv.className = 'readonly-info';
                            const toolName = tool_use.name || 'Unknown';
                            const toolInput = JSON.stringify(tool_use.input || {}).substring(0, 150);
                            toolDiv.textContent = `üîß ${toolName}: ${toolInput}`;
                            card.appendChild(toolDiv);
                        });
                    }

                    // Add tool results if present
                    if (msg.tool_results && msg.tool_results.length > 0) {
                        msg.tool_results.forEach((result, idx) => {
                            const resultDiv = document.createElement('div');
                            resultDiv.className = 'readonly-info';
                            const resultContent = typeof result.content === 'string'
                                ? result.content.substring(0, 150)
                                : JSON.stringify(result.content).substring(0, 150);
                            resultDiv.textContent = `üìã Tool Result: ${resultContent}`;
                            card.appendChild(resultDiv);
                        });
                    }

                } else if (msg.blockType === 'tool') {
                    // Read-only tool info
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'readonly-info';
                    const toolName = msg.toolName || 'Unknown Tool';
                    const toolInput = msg.toolInput || '(no input)';
                    infoDiv.textContent = `üîß ${toolName}: ${toolInput.substring(0, 100)}`;
                    card.appendChild(infoDiv);

                } else if (msg.blockType === 'progress') {
                    // Read-only progress info
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'readonly-info';
                    infoDiv.textContent = `‚è≥ Progress: ${msg.text.substring(0, 100)}`;
                    card.appendChild(infoDiv);

                } else if (msg.blockType === 'file-history') {
                    // Read-only file-history info
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'readonly-info';
                    infoDiv.textContent = `üìÅ ${msg.text}`;
                    card.appendChild(infoDiv);

                } else {
                    // Unknown type - show as read-only text
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'readonly-info';
                    infoDiv.textContent = msg.text;
                    card.appendChild(infoDiv);
                }

                container.appendChild(card);
            });
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function toggleMessageDelete(lineIdx) {
            const msgIdx = editorMessages.findIndex(m => m.lineIdx === lineIdx);
            if (msgIdx >= 0) {
                editorMessages[msgIdx].deleted = !editorMessages[msgIdx].deleted;
                renderEditor();
            }
        }

        function editMessage(lineIdx) {
            const msgIdx = editorMessages.findIndex(m => m.lineIdx === lineIdx);
            if (msgIdx >= 0) {
                const msg = editorMessages[msgIdx];
                const currentText = msg.editedText !== undefined ? msg.editedText : msg.text;
                // Set editedText to current content and enter editing mode
                msg.editedText = currentText;
                msg.isInEditingMode = true;
                renderEditor();
                // Scroll to the textarea
                setTimeout(() => {
                    const textarea = document.querySelector(`textarea[data-line-idx="${lineIdx}"]`);
                    if (textarea) {
                        textarea.focus();
                        textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
        }

        function applyEdit(lineIdx) {
            const msgIdx = editorMessages.findIndex(m => m.lineIdx === lineIdx);
            if (msgIdx >= 0) {
                const msg = editorMessages[msgIdx];
                // Keep editedText and exit editing mode
                msg.isInEditingMode = false;
                renderEditor();
            }
        }

        function cancelEdit(lineIdx) {
            const msgIdx = editorMessages.findIndex(m => m.lineIdx === lineIdx);
            if (msgIdx >= 0) {
                const msg = editorMessages[msgIdx];
                // Discard editedText and exit editing mode
                msg.editedText = undefined;
                msg.isInEditingMode = false;
                renderEditor();
            }
        }

        function rollbackEdit(lineIdx) {
            const msgIdx = editorMessages.findIndex(m => m.lineIdx === lineIdx);
            if (msgIdx >= 0) {
                const msg = editorMessages[msgIdx];
                // Revert editedText to original text
                msg.editedText = undefined;
                renderEditor();
            }
        }

        function showPreview() {
            document.getElementById('placeholderSection').style.display = 'none';
            document.getElementById('previewSection').style.display = 'block';
            document.getElementById('editorSection').style.display = 'none';
            document.querySelector('.main-grid').classList.remove('editor-mode');
        }

        function showEditor() {
            document.getElementById('placeholderSection').style.display = 'none';
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('editorSection').style.display = 'block';
            document.querySelector('.main-grid').classList.add('editor-mode');
        }

        function selectSession(session, element) {
            document.querySelectorAll('.sessions-list li').forEach(li => li.classList.remove('selected'));
            element.classList.add('selected');
            selectedSession = session;

            // Load preview
            fetch(`/api/preview/${selectedAgent}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: session.path })
            })
            .then(r => r.json())
            .then(data => {
                const dict = I18N[LANG] || I18N.en;
                document.getElementById('preview').textContent = data.preview || dict.no_preview;
            })
            .catch(err => console.error(err));

            // Load editor content
            fetch(`/api/editor-content/${selectedAgent}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: session.path })
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    showMessage(`Error loading editor: ${data.error}`, 'error');
                    return;
                }

                editorMessages = data.messages.map(m => ({...m, deleted: false, isInEditingMode: false}));
                renderEditor();
                // Show preview by default
                showPreview();
            })
            .catch(err => {
                showMessage(`Error: ${err}`, 'error');
                console.error(err);
            });

            // Update info
            document.getElementById('sessionInfo').innerHTML = `
                <strong>Project:</strong> ${session.project || 'Unknown'}<br>
                <strong>Date:</strong> ${session.date_str}<br>
                <strong>Size:</strong> ${session.size_str}<br>
                <strong>Path:</strong> <code style="font-size: 11px; word-break: break-all;">${session.path}</code>
            `;
        }

        let lastConversionResult = null;

        document.getElementById('runBtn').addEventListener('click', async () => {
            if (!selectedSession) {
                showMessage(MSG[LANG].select_session, 'error');
                return;
            }

            const runBtn = document.getElementById('runBtn');
            runBtn.disabled = true;

            document.getElementById('outputPanel').style.display = 'block';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('outputButtons').style.display = 'none';

            try {
                const response = await fetch('/api/convert', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agent: selectedAgent,
                        session_path: selectedSession.path,
                        format: selectedFormat,
                        theme: selectedTheme,
                        range: document.getElementById('rangeInput').value,
                        output: document.getElementById('outputInput').value,
                        alibai_time: document.getElementById('alibaiTimeInput').value
                    })
                });

                const data = await response.json();
                document.getElementById('loading').style.display = 'none';

                if (!response.ok) {
                    showMessage(`Error: ${data.error}`, 'error');
                    return;
                }

                if (data.success) {
                    lastConversionResult = data;
                    document.getElementById('outputButtons').style.display = 'flex';
                    showMessage(MSG[LANG].conversion_complete, 'success');
                }
            } catch (err) {
                document.getElementById('loading').style.display = 'none';
                showMessage(`Error: ${err}`, 'error');
            } finally {
                runBtn.disabled = false;
            }
        });

        // Êñ∞„Çø„Éñ„ÅßË°®Á§∫„Éú„Çø„É≥
        document.getElementById('viewBtn').addEventListener('click', () => {
            if (!lastConversionResult) return;

            const data = lastConversionResult;
            const ext = data.format === 'player' || data.format === 'html' ? '.html' :
                       data.format === 'terminal' ? '.txt' : '.md';

            if (data.format === 'html' || data.format === 'player') {
                const blob = new Blob([data.content], { type: 'text/html; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
            } else {
                const blob = new Blob([data.content], { type: 'text/plain; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.target = '_blank';
                a.click();
            }
        });

        // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥
        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (!lastConversionResult) return;

            const data = lastConversionResult;
            const ext = data.format === 'player' || data.format === 'html' ? '.html' :
                       data.format === 'terminal' ? '.txt' : '.md';
            const filename = `output_${new Date().toISOString().slice(0, 10)}${ext}`;

            const blob = new Blob([data.content], {
                type: data.format === 'html' || data.format === 'player' ? 'text/html; charset=utf-8' : 'text/plain; charset=utf-8'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            document.getElementById('rangeInput').value = '';
            document.getElementById('outputInput').value = '';
            document.getElementById('outputPanel').style.display = 'none';
            document.getElementById('outputButtons').style.display = 'none';
            document.getElementById('outputArea').innerHTML = '';
            lastConversionResult = null;
            showMessage(MSG[LANG].reset_complete, 'success');
        });

        // Apply to Output button
        document.getElementById('applyToOutputBtn').addEventListener('click', async () => {
            if (!selectedSession || editorMessages.length === 0) {
                showMessage(MSG[LANG].select_session, 'error');
                return;
            }

            const applyBtn = document.getElementById('applyToOutputBtn');
            applyBtn.disabled = true;

            document.getElementById('outputPanel').style.display = 'block';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('outputButtons').style.display = 'none';

            try {
                // Collect edits
                const edits = editorMessages.map(msg => ({
                    lineIdx: msg.lineIdx,
                    text: msg.editedText !== undefined ? msg.editedText : msg.text,
                    deleted: msg.deleted
                }));

                const response = await fetch('/api/apply-to-output', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agent: selectedAgent,
                        session_path: selectedSession.path,
                        format: selectedFormat,
                        theme: selectedTheme,
                        range: document.getElementById('rangeInput').value,
                        alibai_time: document.getElementById('alibaiTimeInput').value,
                        edits: edits
                    })
                });

                const data = await response.json();
                document.getElementById('loading').style.display = 'none';

                if (!response.ok) {
                    showMessage(`Error: ${data.error}`, 'error');
                    return;
                }

                if (data.success) {
                    lastConversionResult = data;
                    document.getElementById('outputButtons').style.display = 'flex';
                    showMessage(MSG[LANG].conversion_complete, 'success');
                }
            } catch (err) {
                document.getElementById('loading').style.display = 'none';
                showMessage(`Error: ${err}`, 'error');
            } finally {
                applyBtn.disabled = false;
            }
        });

        // Apply to Session Log button
        document.getElementById('applyToSessionBtn').addEventListener('click', async () => {
            if (!selectedSession || editorMessages.length === 0) {
                showMessage(MSG[LANG].select_session, 'error');
                return;
            }

            // Confirm before overwriting
            if (!confirm("‚ö†Ô∏è This will permanently modify the session log file. Continue?")) {
                return;
            }

            const applyBtn = document.getElementById('applyToSessionBtn');
            applyBtn.disabled = true;

            try {
                // Collect edits
                const edits = editorMessages.map(msg => ({
                    lineIdx: msg.lineIdx,
                    text: msg.editedText !== undefined ? msg.editedText : msg.text,
                    deleted: msg.deleted
                }));

                const response = await fetch('/api/apply-to-session-log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agent: selectedAgent,
                        session_path: selectedSession.path,
                        alibai_time: document.getElementById('alibaiTimeInput').value,
                        edits: edits
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    showMessage(`Error: ${data.error}`, 'error');
                    return;
                }

                if (data.success) {
                    showMessage(data.message + " - Reloading editor...", 'success');
                    // Reload editor to show fresh state
                    setTimeout(() => {
                        selectSession(selectedSession, document.querySelector('.sessions-list li.selected'));
                    }, 1000);
                }
            } catch (err) {
                showMessage(`Error: ${err}`, 'error');
            } finally {
                applyBtn.disabled = false;
            }
        });

        // Toggle buttons
        document.getElementById('editBtn').addEventListener('click', () => {
            showEditor();
        });

        document.getElementById('previewBtn').addEventListener('click', () => {
            showPreview();
        });

        function showMessage(msg, type) {
            const container = document.getElementById('messageContainer');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = msg;
            container.innerHTML = '';
            container.appendChild(div);
            setTimeout(() => div.style.opacity = '0', 3000);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Internationalization (i18n)
        const I18N = {
            ja: {
                title: 'üé¨ Claude Session Replay - Web UI',
                settings: '‚öôÔ∏è Ë®≠ÂÆö',
                agent: '„Ç®„Éº„Ç∏„Çß„É≥„Éà:',
                format: '„Éï„Ç©„Éº„Éû„ÉÉ„Éà:',
                player_note: '* Player „Å´„ÅØ Alibai ModeÔºàÊôÇË®àË°®Á§∫„ÄÅÂÜçÁîü„É¢„Éº„ÉâÔºâ„ÅåÂê´„Åæ„Çå„Åæ„Åô',
                theme: '„ÉÜ„Éº„Éû:',
                range: 'Range (‰æã: 1-50,53-):',
                range_placeholder: 'Á©∫ÁôΩ„ÅßÂÖ®‰ª∂',
                alibai_label: 'üïê Alibai „Çπ„Çø„Éº„ÉàÊôÇÂàª (HH:MM):',
                alibai_placeholder: '‰æã: 21:33 (Player „ÅÆ„Åø)',
                alibai_note: 'Player „Éï„Ç©„Éº„Éû„ÉÉ„Éà‰ΩøÁî®ÊôÇ„Å´ÊúâÂäπ',
                output_label: 'Âá∫Âäõ„Éë„Çπ:',
                output_placeholder: 'Á©∫ÁôΩ„Åß„Éñ„É©„Ç¶„Ç∂Ë°®Á§∫„ÅÆ„Åø',
                browse: 'üìÅ ÂèÇÁÖß',
                sessions: 'üìã „Çª„ÉÉ„Ç∑„Éß„É≥',
                editor_heading: '‚úèÔ∏è „Ç®„Éá„Ç£„Çø',
                preview_heading: 'üëÅÔ∏è „Éó„É¨„Éì„É•„Éº',
                preview_placeholder: '„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ...',
                edit_btn: '‚úèÔ∏è Edit',
                preview_btn: 'üëÅÔ∏è Preview',
                info: '‚ÑπÔ∏è ÊÉÖÂ†±',
                info_placeholder: '„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû„Åô„Çã„Å®Ë©≥Á¥∞„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô...',
                run: '‚ñ∂Ô∏è Â§âÊèõÂÆüË°å',
                reset: 'üîÑ „É™„Çª„ÉÉ„Éà',
                apply_to_output: 'üíæ Âá∫Âäõ„Å´ÈÅ©Áî®',
                apply_to_session_log: 'üíæ „Çª„ÉÉ„Ç∑„Éß„É≥„É≠„Ç∞„Å´‰øùÂ≠ò',
                editor_deleted: '(ÂâäÈô§Ê∏à„Åø)',
                editor_restored: 'Âæ©ÂÖÉ',
                output_heading: 'üì§ Âá∫Âäõ',
                processing: 'Âá¶ÁêÜ‰∏≠...',
                view_btn: 'üîç Êñ∞„Çø„Éñ„ÅßË°®Á§∫',
                download_btn: 'üíæ „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ'
            },
            en: {
                title: 'üé¨ Claude Session Replay - Web UI',
                settings: '‚öôÔ∏è Settings',
                agent: 'Agent:',
                format: 'Format:',
                player_note: '* Player includes Alibai Mode (clock display, playback modes)',
                theme: 'Theme:',
                range: 'Range (e.g., 1-50,53-):',
                range_placeholder: 'Leave empty for all',
                alibai_label: 'üïê Alibai Start Time (HH:MM):',
                alibai_placeholder: 'e.g., 21:33 (Player only)',
                alibai_note: 'Effective when using Player format',
                output_label: 'Output Path:',
                output_placeholder: 'Leave empty for display only',
                browse: 'üìÅ Browse',
                sessions: 'üìã Sessions',
                editor_heading: '‚úèÔ∏è Editor',
                preview_heading: 'üëÅÔ∏è Preview',
                preview_placeholder: 'Select a session to preview...',
                edit_btn: '‚úèÔ∏è Edit',
                preview_btn: 'üëÅÔ∏è Preview',
                info: '‚ÑπÔ∏è Info',
                info_placeholder: 'Select a session to view details...',
                run: '‚ñ∂Ô∏è Run Conversion',
                reset: 'üîÑ Reset',
                apply_to_output: 'üíæ Apply to Output',
                apply_to_session_log: 'üíæ Apply to Session Log',
                editor_deleted: '(deleted)',
                editor_restored: 'Restore',
                output_heading: 'üì§ Output',
                processing: 'Processing...',
                view_btn: 'üîç View in New Tab',
                download_btn: 'üíæ Download'
            }
        };

        const MSG = {
            ja: {
                load_error: '„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ',
                no_preview: '„Éó„É¨„Éì„É•„Éº„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
                select_session: '„Åæ„Åö„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                conversion_complete: 'Â§âÊèõÂÆå‰∫ÜÔºÅ',
                reset_complete: '„É™„Çª„ÉÉ„Éà'
            },
            en: {
                load_error: 'Error loading sessions: ',
                no_preview: 'No preview available',
                select_session: 'Please select a session first',
                conversion_complete: 'Conversion complete!',
                reset_complete: 'Reset'
            }
        };

        function applyTranslations() {
            const dict = I18N[LANG] || I18N.en;
            // Apply textContent to elements with data-i18n
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (dict[key]) el.textContent = dict[key];
            });
            // Apply placeholder to input elements with data-i18n-ph
            document.querySelectorAll('[data-i18n-ph]').forEach(el => {
                const key = el.dataset.i18nPh;
                if (dict[key]) el.placeholder = dict[key];
            });
        }

        // Apply translations when DOM is ready
        document.addEventListener('DOMContentLoaded', applyTranslations);

        // Load sessions on startup
        loadSessions();
    </script>
</body>
</html>
